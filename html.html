<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource-Efficient Plant Care Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .plant-bg {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><radialGradient id="bg"><stop offset="0%" style="stop-color:%234ade80;stop-opacity:0.1"/><stop offset="100%" style="stop-color:%2316a34a;stop-opacity:0.05"/></radialGradient></defs><rect width="100%" height="100%" fill="url(%23bg)"/></svg>');
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .metric-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.8));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .dark .metric-card {
            background: linear-gradient(135deg, rgba(31,41,55,0.9), rgba(31,41,55,0.8));
            border: 1px solid rgba(75,85,99,0.2);
        }
        
        .weather-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .moisture-gauge {
            background: conic-gradient(from 0deg, #ef4444 0deg, #f97316 60deg, #eab308 120deg, #22c55e 180deg, #3b82f6 240deg, #8b5cf6 300deg, #ef4444 360deg);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300 plant-bg min-h-screen">
    
    <!-- Navigation -->
    <nav id="navbar" class="bg-white dark:bg-gray-800 shadow-lg sticky top-0 z-50 hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-seedling text-green-600 text-2xl mr-3"></i>
                    <span class="text-xl font-bold text-gray-900 dark:text-white">PlantCare Pro</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="showPage('dashboard')" class="nav-btn text-gray-700 dark:text-gray-300 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-chart-line mr-1"></i> Dashboard
                    </button>
                    <button onclick="showPage('gardens')" class="nav-btn text-gray-700 dark:text-gray-300 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-spa mr-1"></i> My Gardens
                    </button>
                    <button onclick="showPage('settings')" class="nav-btn text-gray-700 dark:text-gray-300 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-cog mr-1"></i> Settings
                    </button>
                    <button id="theme-toggle" class="p-2 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:inline"></i>
                    </button>
                    <div class="flex items-center space-x-2">
                        <span id="username-display" class="text-sm text-gray-700 dark:text-gray-300"></span>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800 px-3 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-sign-out-alt mr-1"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full space-y-8 p-8">
            <div class="text-center fade-in">
                <i class="fas fa-seedling text-6xl text-green-600 mb-4"></i>
                <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white">Plant Care Dashboard</h2>
                <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Monitor and care for your plants</p>
            </div>
            
            <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl fade-in">
                <div class="mb-6">
                    <div class="flex border-b border-gray-200 dark:border-gray-600">
                        <button id="login-tab" onclick="switchAuthTab('login')" class="py-2 px-4 border-b-2 border-green-600 text-green-600 font-medium">Login</button>
                        <button id="register-tab" onclick="switchAuthTab('register')" class="py-2 px-4 text-gray-500 dark:text-gray-400 font-medium ml-4">Register</button>
                    </div>
                </div>
                
                <form id="auth-form" onsubmit="handleAuth(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
                            <input type="text" id="auth-username" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 dark:bg-gray-700 dark:text-white text-base" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                            <input type="password" id="auth-password" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 dark:bg-gray-700 dark:text-white text-base" required>
                        </div>
                        <div id="register-fields" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Confirm Password</label>
                                <input type="password" id="confirm-password" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 dark:bg-gray-700 dark:text-white text-base">
                            </div>
                        </div>
                        <button type="submit" id="auth-submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-200 font-medium">
                            Login
                        </button>
                    </div>
                </form>
                
                <div id="auth-message" class="mt-4 text-center text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboard-page" class="hidden">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            
            <!-- Garden Selector -->
            <div class="mb-6 fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Current Garden</h3>
                        <select id="garden-selector" onchange="selectGarden(this.value)" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white text-base">
                            <option value="">Select a garden...</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Current Status Cards -->
            <div id="status-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <!-- Cards will be populated by JavaScript -->
            </div>

            <!-- Weather Widget -->
            <div id="weather-widget" class="mb-6 hidden">
                <div class="weather-widget rounded-lg shadow p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-medium">Weather Information</h3>
                            <p id="weather-location" class="text-sm opacity-90"></p>
                        </div>
                        <div class="text-right">
                            <div id="weather-temp" class="text-2xl font-bold"></div>
                            <div id="weather-desc" class="text-sm opacity-90"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Plant Metrics Over Time</h3>
                    <canvas id="metrics-chart"></canvas>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Current Status</h3>
                    <canvas id="status-chart"></canvas>
                </div>
            </div>

            <!-- Manual Data Input -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Add Manual Reading</h3>
                <form id="manual-data-form" onsubmit="addManualReading(event)" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Moisture (%)</label>
                        <input type="number" id="manual-moisture" min="0" max="100" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white text-base" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Temperature (°C)</label>
                        <input type="number" id="manual-temperature" min="-10" max="50" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white text-base" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Light (Lux)</label>
                        <input type="number" id="manual-light" min="0" max="2000" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white text-base" required>
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-200">
                            <i class="fas fa-plus mr-1"></i> Add Reading
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Gardens Page -->
    <div id="gardens-page" class="hidden">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">My Gardens</h1>
                <button onclick="showAddGardenModal()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-200">
                    <i class="fas fa-plus mr-2"></i> Add New Garden
                </button>
            </div>
            
            <div id="gardens-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Garden cards will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Settings Page -->
    <div id="settings-page" class="hidden">
        <div class="max-w-4xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-8">Settings</h1>
            
            <!-- User Profile Section -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">User Profile</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
                        <input type="text" id="settings-username" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white text-base" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Member Since</label>
                        <input type="text" id="member-since" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white text-base" readonly>
                    </div>
                </div>
            </div>

            <!-- Data Preferences -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Data Preferences</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Simulation Frequency</label>
                        <select id="sim-frequency" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white text-base">
                            <option value="30">Every 30 seconds</option>
                            <option value="60">Every minute</option>
                            <option value="300">Every 5 minutes</option>
                            <option value="600">Every 10 minutes</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Moisture Alert Threshold (%)</label>
                        <input type="number" id="moisture-threshold" min="0" max="100" value="30" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white text-base">
                    </div>
                </div>
            </div>

            <!-- Data Import/Export -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Data Management</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Import Data</label>
                        <input type="file" id="import-file" accept=".csv" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white text-base">
                        <button onclick="importData()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-upload mr-1"></i> Import CSV
                        </button>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Export Data</label>
                        <button onclick="exportData()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-200">
                            <i class="fas fa-download mr-1"></i> Export All Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Theme Settings -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Appearance</h2>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Dark Mode</span>
                    <button id="theme-toggle-settings" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform dark:translate-x-6"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Garden Modal -->
    <div id="add-garden-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Add New Garden</h3>
                <button onclick="hideAddGardenModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="add-garden-form" onsubmit="addGarden(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Garden Name</label>
                        <input type="text" id="new-garden-name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white text-base" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Location</label>
                        <input type="text" id="new-garden-location" placeholder="e.g., London, UK" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white text-base" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sensor Type</label>
                        <select id="new-garden-sensor" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white text-base">
                            <option value="full">Full Environment Sensor</option>
                            <option value="moisture">Moisture Only</option>
                            <option value="basic">Basic Monitoring</option>
                        </select>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="button" onclick="hideAddGardenModal()" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded-md hover:bg-gray-400 dark:hover:bg-gray-500 transition duration-200">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-200">
                            Add Garden
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentGarden = null;
        let gardens = [];
        let plantData = [];
        let metricsChart = null;
        let statusChart = null;
        let simulationInterval = null;
        let isAuthMode = 'login';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            checkAuthStatus();
            setupThemeToggle();
            loadUserPreferences();
            
            // Check for saved dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
            }
        }

        function checkAuthStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showAuthenticatedApp();
            } else {
                showLoginPage();
            }
        }

        function showLoginPage() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('navbar').classList.add('hidden');
            document.getElementById('dashboard-page').classList.add('hidden');
            document.getElementById('gardens-page').classList.add('hidden');
            document.getElementById('settings-page').classList.add('hidden');
        }

        function showAuthenticatedApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('navbar').classList.remove('hidden');
            document.getElementById('username-display').textContent = currentUser.username;
            
            loadUserData();
            showPage('dashboard');
            startSimulation();
        }

        function switchAuthTab(mode) {
            isAuthMode = mode;
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const registerFields = document.getElementById('register-fields');
            const submitBtn = document.getElementById('auth-submit');

            if (mode === 'login') {
                loginTab.className = 'py-2 px-4 border-b-2 border-green-600 text-green-600 font-medium';
                registerTab.className = 'py-2 px-4 text-gray-500 dark:text-gray-400 font-medium ml-4';
                registerFields.classList.add('hidden');
                submitBtn.textContent = 'Login';
            } else {
                registerTab.className = 'py-2 px-4 border-b-2 border-green-600 text-green-600 font-medium';
                loginTab.className = 'py-2 px-4 text-gray-500 dark:text-gray-400 font-medium ml-4';
                registerFields.classList.remove('hidden');
                submitBtn.textContent = 'Register';
            }
        }

        function handleAuth(event) {
            event.preventDefault();
            const username = document.getElementById('auth-username').value;
            const password = document.getElementById('auth-password').value;
            const messageEl = document.getElementById('auth-message');

            if (isAuthMode === 'register') {
                const confirmPassword = document.getElementById('confirm-password').value;
                if (password !== confirmPassword) {
                    messageEl.innerHTML = '<span class="text-red-600">Passwords do not match</span>';
                    return;
                }

                // Check if user exists
                const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
                if (existingUsers.find(u => u.username === username)) {
                    messageEl.innerHTML = '<span class="text-red-600">Username already exists</span>';
                    return;
                }

                // Register new user
                const newUser = {
                    username: username,
                    password: password, // In production, this should be hashed
                    createdAt: new Date().toISOString(),
                    preferences: {
                        simulationFrequency: 60,
                        moistureThreshold: 30,
                        darkMode: false
                    }
                };

                existingUsers.push(newUser);
                localStorage.setItem('users', JSON.stringify(existingUsers));
                messageEl.innerHTML = '<span class="text-green-600">Registration successful! Please login.</span>';
                
                // Switch to login mode
                switchAuthTab('login');
                document.getElementById('auth-form').reset();
            } else {
                // Login
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const user = users.find(u => u.username === username && u.password === password);

                if (user) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showAuthenticatedApp();
                } else {
                    messageEl.innerHTML = '<span class="text-red-600">Invalid username or password</span>';
                }
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            gardens = [];
            plantData = [];
            currentGarden = null;
            
            if (simulationInterval) {
                clearInterval(simulationInterval);
            }
            
            showLoginPage();
        }

        function showPage(page) {
            // Hide all pages
            document.getElementById('dashboard-page').classList.add('hidden');
            document.getElementById('gardens-page').classList.add('hidden');
            document.getElementById('settings-page').classList.add('hidden');

            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-green-600', 'bg-green-100', 'dark:bg-green-900');
                btn.classList.add('text-gray-700', 'dark:text-gray-300');
            });

            // Show selected page
            document.getElementById(page + '-page').classList.remove('hidden');
            
            // Update active nav button
            event?.target.classList.remove('text-gray-700', 'dark:text-gray-300');
            event?.target.classList.add('text-green-600', 'bg-green-100', 'dark:bg-green-900');

            // Page-specific initialization
            if (page === 'dashboard') {
                initializeDashboard();
            } else if (page === 'gardens') {
                loadGardensPage();
            } else if (page === 'settings') {
                loadSettingsPage();
            }
        }

        function loadUserData() {
            const userKey = `gardens_${currentUser.username}`;
            gardens = JSON.parse(localStorage.getItem(userKey) || '[]');
            
            const dataKey = `plantData_${currentUser.username}`;
            plantData = JSON.parse(localStorage.getItem(dataKey) || '[]');

            // Load current garden selection
            const currentGardenId = localStorage.getItem(`currentGarden_${currentUser.username}`);
            if (currentGardenId && gardens.find(g => g.id === currentGardenId)) {
                currentGarden = gardens.find(g => g.id === currentGardenId);
            } else if (gardens.length > 0) {
                currentGarden = gardens[0];
            }
        }

        function saveUserData() {
            const userKey = `gardens_${currentUser.username}`;
            localStorage.setItem(userKey, JSON.stringify(gardens));
            
            const dataKey = `plantData_${currentUser.username}`;
            localStorage.setItem(dataKey, JSON.stringify(plantData));

            if (currentGarden) {
                localStorage.setItem(`currentGarden_${currentUser.username}`, currentGarden.id);
            }
        }

        function initializeDashboard() {
            updateGardenSelector();
            if (currentGarden) {
                updateDashboard();
                loadWeather();
            }
        }

        function updateGardenSelector() {
            const selector = document.getElementById('garden-selector');
            selector.innerHTML = '<option value="">Select a garden...</option>';
            
            gardens.forEach(garden => {
                const option = document.createElement('option');
                option.value = garden.id;
                option.textContent = garden.name;
                if (currentGarden && garden.id === currentGarden.id) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
        }

        function selectGarden(gardenId) {
            if (gardenId) {
                currentGarden = gardens.find(g => g.id === gardenId);
                localStorage.setItem(`currentGarden_${currentUser.username}`, gardenId);
                updateDashboard();
                loadWeather();
            } else {
                currentGarden = null;
                document.getElementById('status-cards').innerHTML = '';
                document.getElementById('weather-widget').classList.add('hidden');
            }
        }

        function updateDashboard() {
            if (!currentGarden) return;

            updateStatusCards();
            updateCharts();
        }

        function updateStatusCards() {
            const latestData = getLatestGardenData(currentGarden.id);
            const cardsContainer = document.getElementById('status-cards');
            
            const cards = [
                {
                    title: 'Soil Moisture',
                    value: latestData ? `${latestData.moisture}%` : 'No data',
                    icon: 'fas fa-tint',
                    color: getStatusColor('moisture', latestData?.moisture),
                    status: getStatusText('moisture', latestData?.moisture)
                },
                {
                    title: 'Temperature',
                    value: latestData ? `${latestData.temperature}°C` : 'No data',
                    icon: 'fas fa-thermometer-half',
                    color: getStatusColor('temperature', latestData?.temperature),
                    status: getStatusText('temperature', latestData?.temperature)
                },
                {
                    title: 'Light Intensity',
                    value: latestData ? `${latestData.light} Lux` : 'No data',
                    icon: 'fas fa-sun',
                    color: getStatusColor('light', latestData?.light),
                    status: getStatusText('light', latestData?.light)
                },
                {
                    title: 'Last Updated',
                    value: latestData ? new Date(latestData.timestamp).toLocaleTimeString() : 'Never',
                    icon: 'fas fa-clock',
                    color: 'text-gray-600',
                    status: 'Updated'
                }
            ];

            cardsContainer.innerHTML = cards.map(card => `
                <div class="metric-card rounded-lg shadow p-6 card-hover fade-in">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="${card.icon} text-2xl ${card.color}"></i>
                        </div>
                        <div class="ml-4 flex-1">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">${card.title}</p>
                            <p class="text-2xl font-bold text-gray-900 dark:text-white">${card.value}</p>
                            <p class="text-sm ${card.color}">${card.status}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getStatusColor(type, value) {
            if (!value) return 'text-gray-500';
            
            switch (type) {
                case 'moisture':
                    if (value < 30) return 'text-red-500';
                    if (value < 60) return 'text-yellow-500';
                    return 'text-green-500';
                case 'temperature':
                    if (value < 15 || value > 30) return 'text-red-500';
                    if (value < 20 || value > 25) return 'text-yellow-500';
                    return 'text-green-500';
                case 'light':
                    if (value < 200) return 'text-red-500';
                    if (value < 500) return 'text-yellow-500';
                    return 'text-green-500';
                default:
                    return 'text-gray-500';
            }
        }

        function getStatusText(type, value) {
            if (!value) return 'No data';
            
            switch (type) {
                case 'moisture':
                    if (value < 30) return 'Too dry';
                    if (value < 60) return 'Moderate';
                    return 'Well hydrated';
                case 'temperature':
                    if (value < 15) return 'Too cold';
                    if (value > 30) return 'Too hot';
                    if (value < 20 || value > 25) return 'Suboptimal';
                    return 'Optimal';
                case 'light':
                    if (value < 200) return 'Too dark';
                    if (value < 500) return 'Low light';
                    return 'Good light';
                default:
                    return 'Unknown';
            }
        }

        function getLatestGardenData(gardenId) {
            const gardenData = plantData.filter(d => d.gardenId === gardenId);
            return gardenData.length > 0 ? gardenData[gardenData.length - 1] : null;
        }

        function updateCharts() {
            if (!currentGarden) return;

            const gardenData = plantData.filter(d => d.gardenId === currentGarden.id);
            const last24Hours = gardenData.slice(-24); // Show last 24 readings

            // Metrics over time chart
            const ctx1 = document.getElementById('metrics-chart').getContext('2d');
            
            if (metricsChart) {
                metricsChart.destroy();
            }

            metricsChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: last24Hours.map(d => new Date(d.timestamp).toLocaleTimeString()),
                    datasets: [
                        {
                            label: 'Moisture (%)',
                            data: last24Hours.map(d => d.moisture),
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Temperature (°C)',
                            data: last24Hours.map(d => d.temperature),
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Light (Lux/10)',
                            data: last24Hours.map(d => d.light / 10),
                            borderColor: 'rgb(245, 158, 11)',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
                            },
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? '#4b5563' : '#e5e7eb'
                            }
                        },
                        x: {
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
                            },
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? '#4b5563' : '#e5e7eb'
                            }
                        }
                    }
                }
            });

            // Current status doughnut chart
            const ctx2 = document.getElementById('status-chart').getContext('2d');
            
            if (statusChart) {
                statusChart.destroy();
            }

            const latestData = getLatestGardenData(currentGarden.id);
            if (latestData) {
                statusChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Moisture', 'Temperature (×4)', 'Light (/20)'],
                        datasets: [{
                            data: [latestData.moisture, latestData.temperature * 4, latestData.light / 20],
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(245, 158, 11, 0.8)'
                            ],
                            borderWidth: 2,
                            borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
                                }
                            }
                        }
                    }
                });
            }
        }

        async function loadWeather() {
            if (!currentGarden || !currentGarden.location) return;

            try {
                // Using a free weather API (OpenWeatherMap alternative)
                const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(currentGarden.location)}&appid=demo&units=metric`);
                
                // Since we can't use a real API key in this demo, we'll simulate weather data
                const weatherData = {
                    name: currentGarden.location,
                    main: {
                        temp: Math.round(15 + Math.random() * 15)
                    },
                    weather: [{
                        description: ['sunny', 'cloudy', 'rainy', 'partly cloudy'][Math.floor(Math.random() * 4)]
                    }]
                };

                document.getElementById('weather-location').textContent = weatherData.name;
                document.getElementById('weather-temp').textContent = `${weatherData.main.temp}°C`;
                document.getElementById('weather-desc').textContent = weatherData.weather[0].description;
                document.getElementById('weather-widget').classList.remove('hidden');
            } catch (error) {
                console.log('Weather data unavailable');
                document.getElementById('weather-widget').classList.add('hidden');
            }
        }

        function addManualReading(event) {
            event.preventDefault();
            
            if (!currentGarden) {
                alert('Please select a garden first');
                return;
            }

            const moisture = parseInt(document.getElementById('manual-moisture').value);
            const temperature = parseInt(document.getElementById('manual-temperature').value);
            const light = parseInt(document.getElementById('manual-light').value);

            const reading = {
                id: Date.now().toString(),
                gardenId: currentGarden.id,
                timestamp: new Date().toISOString(),
                moisture: moisture,
                temperature: temperature,
                light: light,
                manual: true
            };

            plantData.push(reading);
            saveUserData();
            updateDashboard();
            
            document.getElementById('manual-data-form').reset();
            
            // Show success message
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg z-50';
            message.textContent = 'Reading added successfully!';
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 3000);
        }

        function startSimulation() {
            const frequency = parseInt(localStorage.getItem(`simFrequency_${currentUser.username}`) || '60') * 1000;
            
            if (simulationInterval) {
                clearInterval(simulationInterval);
            }

            simulationInterval = setInterval(() => {
                if (gardens.length > 0) {
                    gardens.forEach(garden => {
                        generateSimulatedData(garden);
                    });
                    saveUserData();
                    if (currentGarden) {
                        updateDashboard();
                    }
                }
            }, frequency);
        }

        function generateSimulatedData(garden) {
            const latestData = getLatestGardenData(garden.id);
            
            // Generate realistic data based on previous reading
            let moisture = latestData ? latestData.moisture : 50;
            let temperature = latestData ? latestData.temperature : 22;
            let light = latestData ? latestData.light : 600;

            // Simulate gradual changes
            moisture += (Math.random() - 0.5) * 5;
            temperature += (Math.random() - 0.5) * 2;
            light += (Math.random() - 0.5) * 100;

            // Apply constraints
            moisture = Math.max(0, Math.min(100, moisture));
            temperature = Math.max(5, Math.min(40, temperature));
            light = Math.max(0, Math.min(2000, light));

            const reading = {
                id: Date.now().toString() + garden.id,
                gardenId: garden.id,
                timestamp: new Date().toISOString(),
                moisture: Math.round(moisture),
                temperature: Math.round(temperature * 10) / 10,
                light: Math.round(light),
                manual: false
            };

            plantData.push(reading);

            // Keep only last 100 readings per garden
            const gardenData = plantData.filter(d => d.gardenId === garden.id);
            if (gardenData.length > 100) {
                const toRemove = gardenData.slice(0, gardenData.length - 100);
                plantData = plantData.filter(d => !toRemove.includes(d));
            }
        }

        function loadGardensPage() {
            const grid = document.getElementById('gardens-grid');
            
            if (gardens.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-seedling text-6xl text-gray-400 mb-4"></i>
                        <h3 class="text-xl font-medium text-gray-900 dark:text-white mb-2">No Gardens Yet</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Create your first garden to start monitoring your plants</p>
                        <button onclick="showAddGardenModal()" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition duration-200">
                            <i class="fas fa-plus mr-2"></i> Add Your First Garden
                        </button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = gardens.map(garden => {
                const latestData = getLatestGardenData(garden.id);
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 card-hover fade-in">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${garden.name}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    <i class="fas fa-map-marker-alt mr-1"></i> ${garden.location}
                                </p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editGarden('${garden.id}')" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteGarden('${garden.id}')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            <div class="text-center">
                                <div class="text-2xl ${getStatusColor('moisture', latestData?.moisture)}">
                                    <i class="fas fa-tint"></i>
                                </div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">
                                    ${latestData ? latestData.moisture + '%' : 'N/A'}
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl ${getStatusColor('temperature', latestData?.temperature)}">
                                    <i class="fas fa-thermometer-half"></i>
                                </div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">
                                    ${latestData ? latestData.temperature + '°C' : 'N/A'}
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl ${getStatusColor('light', latestData?.light)}">
                                    <i class="fas fa-sun"></i>
                                </div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">
                                    ${latestData ? latestData.light + ' Lux' : 'N/A'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="viewGarden('${garden.id}')" class="flex-1 bg-green-600 text-white py-2 px-3 rounded text-sm hover:bg-green-700 transition duration-200">
                                <i class="fas fa-eye mr-1"></i> View Details
                            </button>
                        </div>
                        
                        <div class="mt-3 text-xs text-gray-500 dark:text-gray-400">
                            Sensor: ${garden.sensorType} | Last updated: ${latestData ? new Date(latestData.timestamp).toLocaleString() : 'Never'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewGarden(gardenId) {
            currentGarden = gardens.find(g => g.id === gardenId);
            localStorage.setItem(`currentGarden_${currentUser.username}`, gardenId);
            showPage('dashboard');
        }

        function showAddGardenModal() {
            document.getElementById('add-garden-modal').classList.remove('hidden');
            document.getElementById('add-garden-modal').classList.add('flex');
        }

        function hideAddGardenModal() {
            document.getElementById('add-garden-modal').classList.add('hidden');
            document.getElementById('add-garden-modal').classList.remove('flex');
            document.getElementById('add-garden-form').reset();
        }

        function addGarden(event) {
            event.preventDefault();
            
            const name = document.getElementById('new-garden-name').value;
            const location = document.getElementById('new-garden-location').value;
            const sensorType = document.getElementById('new-garden-sensor').value;

            const garden = {
                id: Date.now().toString(),
                name: name,
                location: location,
                sensorType: sensorType,
                createdAt: new Date().toISOString(),
                lastAccessed: new Date().toISOString()
            };

            gardens.push(garden);
            saveUserData();
            hideAddGardenModal();
            loadGardensPage();

            // Generate initial data
            generateSimulatedData(garden);
            saveUserData();
        }

        function editGarden(gardenId) {
            const garden = gardens.find(g => g.id === gardenId);
            if (!garden) return;

            const newName = prompt('Enter new garden name:', garden.name);
            if (newName && newName !== garden.name) {
                garden.name = newName;
                saveUserData();
                loadGardensPage();
                if (currentGarden && currentGarden.id === gardenId) {
                    currentGarden.name = newName;
                    updateGardenSelector();
                }
            }
        }

        function deleteGarden(gardenId) {
            if (confirm('Are you sure you want to delete this garden? All associated data will be lost.')) {
                gardens = gardens.filter(g => g.id !== gardenId);
                plantData = plantData.filter(d => d.gardenId !== gardenId);
                
                if (currentGarden && currentGarden.id === gardenId) {
                    currentGarden = gardens.length > 0 ? gardens[0] : null;
                }
                
                saveUserData();
                loadGardensPage();
                updateGardenSelector();
            }
        }

        function loadSettingsPage() {
            document.getElementById('settings-username').value = currentUser.username;
            document.getElementById('member-since').value = new Date(currentUser.createdAt).toLocaleDateString();
            
            // Load preferences
            const simFreq = localStorage.getItem(`simFrequency_${currentUser.username}`) || '60';
            document.getElementById('sim-frequency').value = simFreq;
            
            const moistureThreshold = localStorage.getItem(`moistureThreshold_${currentUser.username}`) || '30';
            document.getElementById('moisture-threshold').value = moistureThreshold;
        }

        function loadUserPreferences() {
            const simFreq = localStorage.getItem(`simFrequency_${currentUser?.username}`) || '60';
            
            // Apply simulation frequency
            if (currentUser) {
                startSimulation();
            }

            // Save preferences when changed
            document.getElementById('sim-frequency')?.addEventListener('change', function() {
                localStorage.setItem(`simFrequency_${currentUser.username}`, this.value);
                startSimulation();
            });

            document.getElementById('moisture-threshold')?.addEventListener('change', function() {
                localStorage.setItem(`moistureThreshold_${currentUser.username}`, this.value);
            });
        }

        function setupThemeToggle() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeToggleSettings = document.getElementById('theme-toggle-settings');

            function toggleTheme() {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('darkMode', isDark);
                
                // Update charts if they exist
                if (metricsChart || statusChart) {
                    setTimeout(updateCharts, 100);
                }
            }

            themeToggle?.addEventListener('click', toggleTheme);
            themeToggleSettings?.addEventListener('click', toggleTheme);
        }

        function exportData() {
            const data = {
                gardens: gardens,
                plantData: plantData,
                user: currentUser.username,
                exportDate: new Date().toISOString()
            };

            const csvContent = plantData.map(d => {
                const garden = gardens.find(g => g.id === d.gardenId);
                return [
                    garden?.name || 'Unknown',
                    d.timestamp,
                    d.moisture,
                    d.temperature,
                    d.light,
                    d.manual ? 'Manual' : 'Simulated'
                ].join(',');
            });

            csvContent.unshift('Garden,Timestamp,Moisture,Temperature,Light,Type');

            const blob = new Blob([csvContent.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `plant_data_${currentUser.username}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            // Show success message
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg z-50';
            message.textContent = 'Data exported successfully!';
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 3000);
        }

        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file to import');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',');
                    
                    // Simple CSV parsing (assumes format: Garden,Timestamp,Moisture,Temperature,Light,Type)
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        if (values.length >= 5) {
                            const gardenName = values[0];
                            let garden = gardens.find(g => g.name === gardenName);
                            
                            if (!garden) {
                                // Create new garden if it doesn't exist
                                garden = {
                                    id: Date.now().toString() + i,
                                    name: gardenName,
                                    location: 'Imported',
                                    sensorType: 'imported',
                                    createdAt: new Date().toISOString(),
                                    lastAccessed: new Date().toISOString()
                                };
                                gardens.push(garden);
                            }

                            const reading = {
                                id: Date.now().toString() + i,
                                gardenId: garden.id,
                                timestamp: values[1] || new Date().toISOString(),
                                moisture: parseFloat(values[2]) || 0,
                                temperature: parseFloat(values[3]) || 0,
                                light: parseFloat(values[4]) || 0,
                                manual: true
                            };

                            plantData.push(reading);
                        }
                    }

                    saveUserData();
                    loadGardensPage();
                    updateGardenSelector();
                    if (currentGarden) {
                        updateDashboard();
                    }

                    // Show success message
                    const message = document.createElement('div');
                    message.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg z-50';
                    message.textContent = 'Data imported successfully!';
                    document.body.appendChild(message);
                    setTimeout(() => message.remove(), 3000);

                    fileInput.value = '';
                } catch (error) {
                    alert('Error importing data. Please check the CSV format.');
                }
            };
            reader.readAsText(file);
        }

        // Initialize dark mode on page load
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches && !localStorage.getItem('darkMode')) {
                document.documentElement.classList.add('dark');
            } else if (!event.matches && !localStorage.getItem('darkMode')) {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
</body>
</html>